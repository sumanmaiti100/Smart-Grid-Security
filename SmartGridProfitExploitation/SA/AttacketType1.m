yalmip('clear')
clear all;
opts = sdpsettings('verbose', 1, 'solver', 'fmincon');   %solver %
format long

fr=[];
Profit=[];

% Define the data with 1000 elements (as an example, you can replace these arrays with your actual data)
ScheduledGenerationMW_Actual = [271.995320000000,272.000470000000,271.998380000000,271.997280000000,271.997590000000,273.003910000000,272.003700000000,271.995190000000,272.997510000000,272.998540000000,273.004960000000,272.001000000000,272.002580000000,205.199700000000,165.295640000000,119.056980000000,79.9964200000000,80.0017900000000,80.0014300000000,80.0028600000000,80.0034900000000,79.9978300000000,80.0024500000000,79.9998900000000,80.0036700000000,79.9956300000000,80.0029200000000,80.0004500000000,79.9993200000000,80.0043200000000,79.9957800000000,80.0047100000000,79.9959500000000,79.9994900000000,80.0011700000000,80.0047300000000,80.0036800000000,80.0025700000000,79.9965900000000,79.9959100000000,79.9978400000000,80.0022800000000,80.0000600000000,79.9995500000000,80.0009300000000,79.9989400000000,79.9972100000000,80.0046000000000,79.9958900000000,79.9964100000000,80.0033600000000,80.0025300000000,79.9951900000000,80.0001500000000,80.0042000000000,79.9958300000000,79.9997500000000,79.9968000000000,80.0012400000000,80.0029100000000,79.9966000000000,80.0015200000000,80.0015900000000,80.0000700000000,80.0043200000000,80.0026300000000,80.0027800000000,79.9976100000000,80.0026300000000,80.0000800000000,79.9978000000000,79.9994100000000,79.9962100000000,80.0044900000000,80.0029700000000,79.9954000000000,79.9960200000000,79.9980000000000,80.0010100000000,80.0023800000000,79.9959000000000,79.9971600000000,80.0034500000000,80.0014200000000,80.0004000000000,80.0011000000000,167.995400000000,167.996520000000,168.001580000000,167.998590000000,215.626740000000,256.003680000000,240.784230000000,226.415520000000,257.003360000000,255.999360000000,236.469220000000,196.365730000000,174.004940000000,167.998760000000,238.737280000000,238.540210000000,203.984320000000,192.995190000000,192.997360000000,198.000660000000,187.997020000000,191.126230000000,173.999650000000,170.000740000000,169.996310000000,167.998420000000,167.997710000000,167.999020000000,167.996560000000,112.004390000000,111.995520000000,89.0035800000000,80.0048500000000,79.9983900000000,84.9985200000000,79.9978600000000,80.3001400000000,80.0047100000000,80.0018300000000,80.0036800000000,80.0010900000000,80.0033900000000,80.0040000000000,79.9973600000000,79.9967900000000,80.0035900000000,79.9981400000000,80.0009700000000,80.0004100000000,79.9997000000000,80.0015000000000,79.9962900000000,80.0037800000000,79.9989600000000,79.9982100000000,79.9991800000000,79.9982000000000,80.0015600000000,80.0046800000000];


SemiScheduledGenerationMW_Actual = [1800.30468000000,1812.54953000000,1766.10162000000,1759.98272000000,1760.04241000000,1770.35609000000,1857.47630000000,1890.07481000000,1871.59249000000,1870.29146000000,1872.68504000000,1884.32900000000,1899.16742000000,1907.11030000000,1898.73436000000,1887.80302000000,1873.68358000000,1860.43821000000,1864.82857000000,1853.32714000000,1860.64651000000,1880.16217000000,1863.99755000000,1861.26011000000,1861.34633000000,1872.90437000000,1868.10708000000,1862.94955000000,1849.35068000000,1848.17568000000,1836.66422000000,1800.79529000000,1794.34405000000,1838.08051000000,1866.70883000000,1861.06527000000,1848.11632000000,1851.93743000000,1840.18341000000,1845.49409000000,1847.75216000000,1844.80772000000,1858.23994000000,1806.50045000000,1843.36907000000,1849.85106000000,1847.35279000000,1851.14540000000,1857.16411000000,1851.59359000000,1848.78664000000,1840.32747000000,1839.23481000000,1838.01985000000,1851.22580000000,1852.23417000000,1846.56025000000,1867.66320000000,1851.99876000000,1859.69709000000,1868.15340000000,1882.65848000000,1883.80841000000,1872.42993000000,1881.08568000000,1873.15737000000,1871.11722000000,1877.97239000000,1873.36737000000,1858.68992000000,1868.38220000000,1848.57059000000,1859.73379000000,1836.78551000000,1819.62703000000,1825.24460000000,1825.74398000000,1819.90200000000,1808.23899000000,1821.25762000000,1807.24410000000,1784.57284000000,1802.23655000000,1807.20858000000,1802.19960000000,1811.03890000000,1812.38460000000,1822.52348000000,1824.26842000000,1805.02141000000,1802.19326000000,1800.44632000000,1797.76577000000,1818.36448000000,1841.61664000000,1850.89064000000,1852.38078000000,1833.46427000000,1845.20506000000,1825.38124000000,1832.59272000000,1820.02979000000,1826.44568000000,1903.97481000000,1919.09264000000,1915.48934000000,1919.95298000000,1928.26377000000,1914.00035000000,1890.00926000000,1893.24369000000,1878.94158000000,1864.21229000000,1858.49098000000,1863.42344000000,1908.18561000000,1906.05448000000,1898.46642000000,1895.81515000000,1905.22161000000,1892.30148000000,1836.40214000000,1778.96986000000,1705.50529000000,1732.39817000000,1658.86632000000,1787.88891000000,1762.08661000000,1698.37600000000,1769.79264000000,1805.77321000000,1817.93641000000,1803.77186000000,1799.64903000000,1788.21959000000,1821.09030000000,1786.09850000000,1742.83371000000,1694.76622000000,1739.56104000000,1763.45179000000,1700.46082000000,1600.50180000000,1659.06844000000,1693.89532000000];


ScheduledDemandMW_Actual = [1608.13000000000,1572.94000000000,1576.50000000000,1579.63000000000,1576.87000000000,1578.76000000000,1584.96000000000,1588.78000000000,1600.66000000000,1552.42000000000,1630.12000000000,1594.04000000000,1590.44000000000,1584.14000000000,1560.73000000000,1544.29000000000,1529.71000000000,1522.77000000000,1518.25000000000,1501.75000000000,1506.49000000000,1490.36000000000,1501.30000000000,1492.47000000000,1476.40000000000,1470.46000000000,1479.11000000000,1447.99000000000,1435.33000000000,1432.66000000000,1424.98000000000,1413.59000000000,1403.43000000000,1418.66000000000,1396.88000000000,1389.68000000000,1387,1373.50000000000,1386.54000000000,1399.58000000000,1356.83000000000,1369.56000000000,1356.44000000000,1366.36000000000,1383.26000000000,1392.20000000000,1384.80000000000,1376.48000000000,1374.08000000000,1363.76000000000,1375.36000000000,1356.75000000000,1375.01000000000,1377.76000000000,1354.04000000000,1350.77000000000,1369.13000000000,1369.19000000000,1360.05000000000,1361.90000000000,1351.65000000000,1360.70000000000,1372.02000000000,1362.19000000000,1378.57000000000,1398.94000000000,1347.54000000000,1373.70000000000,1348.78000000000,1339.56000000000,1341.06000000000,1343.72000000000,1359.03000000000,1339.33000000000,1348.11000000000,1350.99000000000,1347.27000000000,1345.92000000000,1348.58000000000,1345.60000000000,1351.85000000000,1399.38000000000,1386.31000000000,1413.97000000000,1425.09000000000,1429.50000000000,1414.45000000000,1425.07000000000,1419.67000000000,1446.76000000000,1438.63000000000,1435.94000000000,1461.55000000000,1467.78000000000,1473.53000000000,1475.80000000000,1475.85000000000,1467.15000000000,1474.68000000000,1453.91000000000,1440.33000000000,1442.25000000000,1422.43000000000,1401.38000000000,1414.26000000000,1413.49000000000,1429.54000000000,1419.39000000000,1398.72000000000,1394.52000000000,1387.08000000000,1365.74000000000,1332.21000000000,1326.49000000000,1331.42000000000,1339.82000000000,1322.82000000000,1322.27000000000,1306.02000000000,1294.01000000000,1277.30000000000,1271.36000000000,1294.27000000000,1298.92000000000,1304.68000000000,1264.67000000000,1320.14000000000,1333.04000000000,1323.97000000000,1352.83000000000,1361.74000000000,1332.33000000000,1299.92000000000,1316.55000000000,1314.59000000000,1328.05000000000,1325.19000000000,1247.66000000000,1225.91000000000,1218.32000000000,1235.42000000000,1231.83000000000,1172.26000000000,1175.44000000000,1181.06000000000];


ScheduleGenerationMW_Forecast_N = [173.004110000000,173.004110000000,173.004110000000,173.004110000000,173.004110000000,173.004110000000,172.999110000000,172.999110000000,172.999110000000,172.999110000000,172.999110000000,172.999110000000,173.001110000000,173.001110000000,173.001110000000,173.001110000000,173.001110000000,173.001110000000,0.00311000000000000,0.00311000000000000,0.00311000000000000,0.00311000000000000,0.00311000000000000,0.00311000000000000,-0.00489000000000000,-0.00489000000000000,-0.00489000000000000,-0.00489000000000000,-0.00489000000000000,-0.00489000000000000,-0.000920000000000000,-0.000920000000000000,-0.000920000000000000,-0.000920000000000000,-0.000920000000000000,-0.000920000000000000,0.00231000000000000,0.00231000000000000,0.00231000000000000,0.00231000000000000,0.00231000000000000,0.00231000000000000,-0.000180000000000000,-0.000180000000000000,-0.000180000000000000,-0.000180000000000000,-0.000180000000000000,-0.000180000000000000,-0.00460000000000000,-0.00460000000000000,-0.00460000000000000,-0.00460000000000000,-0.00460000000000000,-0.00460000000000000,0.00112000000000000,0.00112000000000000,0.00112000000000000,0.00112000000000000,0.00112000000000000,0.00112000000000000,0.00498000000000000,0.00498000000000000,0.00498000000000000,0.00498000000000000,0.00498000000000000,0.00498000000000000,0.00311000000000000,0.00311000000000000,0.00311000000000000,0.00311000000000000,0.00311000000000000,0.00311000000000000,-0.00489000000000000,-0.00489000000000000,-0.00489000000000000,-0.00489000000000000,-0.00489000000000000,-0.00489000000000000,0.000110000000000000,0.000110000000000000,0.000110000000000000,0.000110000000000000,0.000110000000000000,0.000110000000000000,-0.00389000000000000,-0.00389000000000000,-0.00389000000000000,-0.00389000000000000,-0.00389000000000000,-0.00389000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,-0.000890000000000000,-0.000890000000000000,-0.000890000000000000,-0.000890000000000000,-0.000890000000000000,-0.000890000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,0.00411000000000000,-0.00289000000000000,-0.00289000000000000,-0.00289000000000000,-0.00289000000000000,-0.00289000000000000,-0.00289000000000000,-0.00154000000000000,-0.00154000000000000,-0.00154000000000000,-0.00154000000000000,-0.00154000000000000,-0.00154000000000000,0,0,0,0,0,0,0.00210000000000000,0.00210000000000000,0.00210000000000000,0.00210000000000000,0.00210000000000000,0.00210000000000000,0,0,0,0,0,0,-0.00367000000000000];


SemiScheduleGenerationMW_Forecast_N = [1921.41589000000,1921.41589000000,1921.41589000000,1921.41589000000,1921.41589000000,1921.41589000000,1931.74089000000,1931.74089000000,1931.74089000000,1931.74089000000,1931.74089000000,1931.74089000000,1940.47889000000,1940.47889000000,1940.47889000000,1940.47889000000,1940.47889000000,1940.47889000000,1929.33689000000,1929.33689000000,1929.33689000000,1929.33689000000,1929.33689000000,1929.33689000000,1922.29489000000,1922.29489000000,1922.29489000000,1922.29489000000,1922.29489000000,1922.29489000000,1915.89092000000,1915.89092000000,1915.89092000000,1915.89092000000,1915.89092000000,1915.89092000000,1904.76769000000,1904.76769000000,1904.76769000000,1904.76769000000,1904.76769000000,1904.76769000000,1892.99018000000,1892.99018000000,1892.99018000000,1892.99018000000,1892.99018000000,1892.99018000000,1869.79460000000,1869.79460000000,1869.79460000000,1869.79460000000,1869.79460000000,1869.79460000000,1854.13888000000,1854.13888000000,1854.13888000000,1854.13888000000,1854.13888000000,1854.13888000000,1839.33502000000,1839.33502000000,1839.33502000000,1839.33502000000,1839.33502000000,1839.33502000000,1817.51689000000,1817.51689000000,1817.51689000000,1817.51689000000,1817.51689000000,1817.51689000000,1791.90489000000,1791.90489000000,1791.90489000000,1791.90489000000,1791.90489000000,1791.90489000000,1768.20989000000,1768.20989000000,1768.20989000000,1768.20989000000,1768.20989000000,1768.20989000000,1742.46389000000,1742.46389000000,1742.46389000000,1742.46389000000,1742.46389000000,1742.46389000000,1727.52589000000,1727.52589000000,1727.52589000000,1727.52589000000,1727.52589000000,1727.52589000000,1725.20589000000,1725.20589000000,1725.20589000000,1725.20589000000,1725.20589000000,1725.20589000000,1744.56089000000,1744.56089000000,1744.56089000000,1744.56089000000,1744.56089000000,1744.56089000000,1779.06589000000,1779.06589000000,1779.06589000000,1779.06589000000,1779.06589000000,1779.06589000000,1819.67289000000,1819.67289000000,1819.67289000000,1819.67289000000,1819.67289000000,1819.67289000000,1813.11154000000,1813.11154000000,1813.11154000000,1813.11154000000,1813.11154000000,1813.11154000000,1729,1729,1729,1729,1729,1729,1663.00790000000,1663.00790000000,1663.00790000000,1663.00790000000,1663.00790000000,1663.00790000000,1575,1575,1575,1575,1575,1575,1509.52367000000];


NetImportMW_Actual = [470.790000000000,520.010000000000,468.160000000000,458.620000000000,461.410000000000,471.120000000000,553.480000000000,583.330000000000,552.400000000000,601.830000000000,522.790000000000,571.540000000000,590.630000000000,536.200000000000,510.730000000000,468.610000000000,429.210000000000,422.540000000000,431.840000000000,437.050000000000,439.490000000000,476.400000000000,448.410000000000,454.760000000000,471.520000000000,489.320000000000,475.410000000000,502.510000000000,501.600000000000,502.920000000000,499.190000000000,474.010000000000,477.920000000000,507.180000000000,559.370000000000,561.180000000000,550.380000000000,568.650000000000,542.620000000000,535,581.870000000000,565.860000000000,593.710000000000,529.260000000000,549.550000000000,547.010000000000,552.490000000000,564.920000000000,573.630000000000,579.200000000000,563.620000000000,573.990000000000,553.750000000000,549.620000000000,588.360000000000,592.770000000000,567.750000000000,589.510000000000,582.810000000000,588.900000000000,609.030000000000,615.260000000000,603.480000000000,602.190000000000,594.030000000000,564.630000000000,616.810000000000,596.300000000000,618.230000000000,612.590000000000,620.790000000000,596.890000000000,592.510000000000,589.550000000000,562.840000000000,565.530000000000,569.940000000000,565.380000000000,550.460000000000,567.210000000000,545.880000000000,473.110000000000,504.940000000000,481.640000000000,464.850000000000,469.690000000000,577.910000000000,577.400000000000,584.780000000000,536.490000000000,591.860000000000,635.430000000000,589.360000000000,589.330000000000,640.240000000000,646.780000000000,627.090000000000,574.530000000000,555.860000000000,550.720000000000,647.150000000000,633.290000000000,624.810000000000,720.210000000000,721.310000000000,723.950000000000,701.500000000000,724.120000000000,711.870000000000,685.760000000000,698.840000000000,703.260000000000,724.840000000000,724.890000000000,724.590000000000,702.400000000000,719.540000000000,685.690000000000,690.940000000000,714.860000000000,724.980000000000,663.780000000000,578.410000000000,498.240000000000,520.430000000000,488.300000000000,560.270000000000,520.320000000000,464.590000000000,507.220000000000,535.660000000000,578.370000000000,598.010000000000,575.550000000000,565.920000000000,585.830000000000,552.800000000000,588.130000000000,561.910000000000,615.840000000000,623.210000000000,561.260000000000,519.360000000000,577.240000000000,607.460000000000];


NetImportMWForecast_N = [554.160000000000,554.160000000000,554.160000000000,554.160000000000,554.160000000000,554.160000000000,577.520000000000,577.520000000000,577.520000000000,577.520000000000,577.520000000000,577.520000000000,581.610000000000,581.610000000000,581.610000000000,581.610000000000,581.610000000000,581.610000000000,399.540000000000,399.540000000000,399.540000000000,399.540000000000,399.540000000000,399.540000000000,429.870000000000,429.870000000000,429.870000000000,429.870000000000,429.870000000000,429.870000000000,480.470000000000,480.470000000000,480.470000000000,480.470000000000,480.470000000000,480.470000000000,549.130000000000,549.130000000000,549.130000000000,549.130000000000,549.130000000000,549.130000000000,583.980000000000,583.980000000000,583.980000000000,583.980000000000,583.980000000000,583.980000000000,589.290000000000,589.290000000000,589.290000000000,589.290000000000,589.290000000000,589.290000000000,590.930000000000,590.930000000000,590.930000000000,590.930000000000,590.930000000000,590.930000000000,587.310000000000,587.310000000000,587.310000000000,587.310000000000,587.310000000000,587.310000000000,573.660000000000,573.660000000000,573.660000000000,573.660000000000,573.660000000000,573.660000000000,542.720000000000,542.720000000000,542.720000000000,542.720000000000,542.720000000000,542.720000000000,505.250000000000,505.250000000000,505.250000000000,505.250000000000,505.250000000000,505.250000000000,438.320000000000,438.320000000000,438.320000000000,438.320000000000,438.320000000000,438.320000000000,400.420000000000,400.420000000000,400.420000000000,400.420000000000,400.420000000000,400.420000000000,363.950000000000,363.950000000000,363.950000000000,363.950000000000,363.950000000000,363.950000000000,397.480000000000,397.480000000000,397.480000000000,397.480000000000,397.480000000000,397.480000000000,510.510000000000,510.510000000000,510.510000000000,510.510000000000,510.510000000000,510.510000000000,664.850000000000,664.850000000000,664.850000000000,664.850000000000,664.850000000000,664.850000000000,727.010000000000,727.010000000000,727.010000000000,727.010000000000,727.010000000000,727.010000000000,727.220000000000,727.220000000000,727.220000000000,727.220000000000,727.220000000000,727.220000000000,728.200000000000,728.200000000000,728.200000000000,728.200000000000,728.200000000000,728.200000000000,728.760000000000,728.760000000000,728.760000000000,728.760000000000,728.760000000000,728.760000000000,728.270000000000];


k = 6;
epsilon = 1e-10; % Small value to prevent division by zero
num_iterations = floor(length(ScheduledGenerationMW_Actual) / k); % Number of 6-value windows

% Initialize arrays to store Lambda and b values for all iterations
Lambda_values = zeros(1, num_iterations); % Preallocate for 1000 elements
b_values = zeros(1, num_iterations);      % Preallocate for 1000 elements

% Initialize final objective value
final_objective_value = 0;

for i = 1:num_iterations
    % Extract the current window of 6 values
    ScheduledGenerationMW_Actual_window = ScheduledGenerationMW_Actual((i-1)*k + 1:i*k);
    SemiScheduledGenerationMW_Actual_window = SemiScheduledGenerationMW_Actual((i-1)*k + 1:i*k);
    ScheduledDemandMW_Actual_window = ScheduledDemandMW_Actual((i-1)*k + 1:i*k);
    ScheduleGenerationMW_Forecast_N_window = ScheduleGenerationMW_Forecast_N((i-1)*k + 1:i*k);
    SemiScheduleGenerationMW_Forecast_N_window = SemiScheduleGenerationMW_Forecast_N((i-1)*k + 1:i*k);
    NetImportMW_Actual_window = NetImportMW_Actual((i-1)*k + 1:i*k);
    NetImportMWForecast_N_window = NetImportMWForecast_N((i-1)*k + 1:i*k);
    
    b = sdpvar(1, k, 'full');
    Lambda = sdpvar(1, k, 'full');
    constraints = [];
    objectiveFunction = 0;

    for m = 1:k
        if m == 1
            b(1,1) = 1; % Initial value
            Lambda(1,1) = 86.37; % Initial value for Lambda
        else
            Lambda(1,m) = Lambda(1,(m-1))*(1- (ScheduledGenerationMW_Actual_window(1,(m-1))+ SemiScheduledGenerationMW_Actual_window(1,(m-1))-ScheduledDemandMW_Actual_window(1,(m-1)))/(ScheduleGenerationMW_Forecast_N_window(1,(m-1))+SemiScheduleGenerationMW_Forecast_N_window(1,(m-1))-ScheduledDemandMW_Actual_window(1,(m-1)))+(b(1,(m-1))*NetImportMW_Actual_window(1,(m-1)))/(NetImportMWForecast_N_window(1,(m-1))));
            constraints = [constraints, ...
                ((ScheduledGenerationMW_Actual_window(1,m) + SemiScheduledGenerationMW_Actual_window(1,m) - ScheduledDemandMW_Actual_window(1,m) + (b(1,m)*NetImportMW_Actual_window(1,m)))) >= -180, ...
                ((ScheduledGenerationMW_Actual_window(1,m) + SemiScheduledGenerationMW_Actual_window(1,m) - ScheduledDemandMW_Actual_window(1,m) + (b(1,m)*NetImportMW_Actual_window(1,m)))) <= 180, ...
                Lambda(1,m)>=-800, ...
                Lambda(1,m)<=600, ...
                b(1,m) >=-2, ...
                b(1,m) <=2];
            objectiveFunction = objectiveFunction + Lambda(1,m)*b(1,m)*(NetImportMW_Actual_window(1,m));
              
        end
       
    end

    optimize(constraints, objectiveFunction, opts);
    
    % Store the computed values of Lambda and b in the arrays
    Lambda_values((i-1)*k + 1:i*k) = value(Lambda);
    b_values((i-1)*k + 1:i*k) = value(b);
    
    final_objective_value = final_objective_value + value(abs(objectiveFunction));
end


for i = 1:length(Lambda_values)
    if Lambda_values(1,i)>=600
        Lambda_values(1,i) =600;
    end
end

for j = 1:144
    if(Lambda_values(1,j)<=-20)
        Lambda_values(1,j)=-20;
    end
    Profit(1,j) = abs(Lambda_values(1,j)*b_values(1,j)*NetImportMW_Actual(1,j));
end


for j = 1:144
    fr(1,j) = 60+(ScheduledGenerationMW_Actual(1,j)+SemiScheduledGenerationMW_Actual(1,j)-ScheduledDemandMW_Actual(1,j)+b_values(1,j)*NetImportMW_Actual(1,j))/1800;
end


final_objective_value
%Lambda_values
%b_values
